<html>
  <head>
    <title>Open Data Sets in Waterloo Region</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
    <!--[if lte IE 8]>
      <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
    <![endif]-->
    <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <style>
      #map {  height: 100%;
              margin: 0px;
              /*width:75%;*/
           }
      .leaflet-popup-content table {
        border-collapse:collapse;
        
      }
      .leaflet-popup-content tr:nth-child(even) {background: #f7f7f7}
      .leaflet-popup-content tr:nth-child(odd) {background: #FFF}
      .leaflet-popup-content td,
      .leaflet-popup-content th {
        padding: 5px 10px;
        border-color: #eee;
        border-width: 1px;
        border-style: solid;
        font-size: 11px;}
      .info {
          padding: 6px 8px;
          font: 14px/16px Arial, Helvetica, sans-serif;
          background: white;
          background: rgba(255,255,255,0.8);
          box-shadow: 0 0 15px rgba(0,0,0,0.2);
          border-radius: 5px;
      }
      .info h4 {
          margin: 0 0 5px;
          color: #777;
      }
      .legend {
          line-height: 18px;
          color: #555;
      }
      .legend i {
          width: 18px;
          height: 18px;
          float: left;
          margin-right: 8px;
          opacity: 0.7;
      }
    </style>
    
    <script>
      function onEachFeature(feature, layer) {
        // does this feature have a property named popupContent?
        if (feature.properties) {
          html = '<table>'
          $.each(feature.properties, function( k, v ) {
            html += '<tr><th>' + k + '</td><td>' + v + '</td></tr>';
          });
          html+= '</table>';
          layer.bindPopup(html, {closeButton:false});
        }
      }
      
      
      datasets = [
        {
          name: 'GRT Routes',
          url: 'grt_routes.topojson',
          ref: 'grt_routes',
          style: function(feature) {
            return { color: 'rgb(' + ((feature.properties.Route*10) % 256) + ',0,' + ((255-feature.properties.Route*10) % 256) + ')'};
          }
        },
        {
          name: 'GRT Stops',
          url: 'grt_stops.topojson',
          ref: 'grt_stops',
          icon: 'icons/bus-12.png', 
          style: function(feature) {
            return {};
          }
        },
        {
          name: 'Blue W',
          url: 'BlueW.topojson',
          ref: 'BlueW',
          icon: 'icons/water-12.png', 
          style: function(feature) {
            return {};
          }
        },
        {
          name: 'Water Wagon',
          url: 'water_wagon.json',
          ref: 'water_wagon',
          icon: 'icons/glass-12.png', 
          style: function(feature) {
            return {};
          }
        },
        {
          name: 'Creeks',
          url: 'creeks.topojson',
          ref: 'creeks',
          style: function(feature) {
            return { color: '#6CF'};
          }
        },
        {
          name: 'Rivers',
          url: 'rivers.topojson',
          ref: 'rivers',
          style: function(feature) {
            return { color: '#369'};
          }
        },
        {
          name: 'Doors Open Waterloo Region 2013',
          url: 'doors_open_2013.json',
          ref: 'doors_open_2013',
          icon: 'icons/town-hall-12.png', 
          style: function(feature) {
            return {};
          }
        },
        {
          name: 'Food Facilities',
          url: 'food_facilities.topojson',
          ref: 'food_facilities',
          icon: 'icons/restaurant-12.png', 
          style: function(feature) {
            return {};
          }
        },
        {
          name: 'Regional Libraries',
          url: 'regional_libraries.json',
          ref: 'regional_libraries',
          icon: 'icons/library-12.png', 
          style: function(feature) {
            return {};
          }
        },
        {
          name: 'Regional Boundarieas',
          url: 'regional_boundaries.topojson',
          ref: 'regional_boundaries',
          style: function(feature) {
            if (feature.properties.Municipali == 'Kitchener') {
              return { color: '#006f4c'};
            } else if (feature.properties.Municipali == 'Waterloo') {
              return { color: '#333'};
            } else if (feature.properties.Municipali == 'Cambridge') {
              return { color: '#d49b1d'};
            } else if (feature.properties.Municipali == 'Wilmot') {
              return { color: '#00418F'};
            } else if (feature.properties.Municipali == 'Wellesley') {
              return { color: '#ffc'};
            } else if (feature.properties.Municipali == 'Woolwich') {
              return { color: '#a90000'};
            } else if (feature.properties.Municipali == 'North Dumfries') {
              return { color: '#28609a'};
            } 
            return {};
          }
        },
        {
          name: 'Ward Boundarieas',
          url: 'ward_boundaries.topojson',
          ref: 'ward_boundaries',
          style: function(feature) {
            return { color: Math.floor(Math.random()*16777215).toString(16) };
          }
        }
      ];
        
      $(document).ready(function(){
        var map = L.map('map', {
          center: [43.452763, -80.484453],
          zoom: 13,
          maxBounds: [[43.2615,-80.8698],[43.7,-80.161]]});
        
        L.tileLayer('http://maps.tritag.ca/bike/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap contributors, ODbL</a>',
            minZoom: 11
        }).addTo(map);
        
        L.control.scale().addTo(map);
        
        var legend = L.control({position: 'bottomright'});

        legend.onAdd = function (map) {
        
            var div = L.DomUtil.create('div', 'info legend');
            
            datasets.map(function(dataset) {
              div.innerHTML += '<input type="checkbox" id="' +
                dataset.ref + '" name="a" value="b"/>' + dataset.name + '<br/>'
              
            });
            
            return div;
        };
        
        legend.addTo(map);
        
        datasets.map(function(dataset) {
          $('#'+dataset.ref).change(function() {
            if (this.checked) {
              if (dataset.layer) {
                dataset.layer.addTo(map);
              } else {
                $.getJSON(dataset.url, function(data) {
                  dataset.data = data;
                  if (dataset.url.indexOf('topojson') > 0) {
                    geodata = topojson.feature(data, data.objects[dataset.ref]);
                  } else {
                    geodata = data
                  }
                  if (dataset.icon) {
                    dataset.layer = L.geoJson(geodata, {
                      style: dataset.style,
                      pointToLayer: function(featuer, latlng) {
                        return L.marker(latlng, {icon:
                                        L.icon({ iconUrl: dataset.icon,
                                                iconSize: [12, 12],
                                                iconAnchor: [6, 6],
                                                popupAnchor: [0, -7],})
                                        });
                      },
                      onEachFeature: onEachFeature}).addTo(map);
                  } else {
                    dataset.layer = L.geoJson(geodata, {
                      style: dataset.style,
                      onEachFeature: onEachFeature}).addTo(map);
                  }
                });
              }
            } else {
              map.removeLayer(dataset.layer);
            }
          });
        });
      });
    </script>
  </head>
  <body>
    <div id='map'></div>
  </body>
</html>